openapi: 3.0.3
info:
  title: M77 Config Service API
  version: 1.0.0
  description: Manage dynamic configuration keys, values, rollout rules, audit, import/export, and rollback.
servers:
  - url: /
security:
  - bearerAuth: []
tags:
  - name: Config
  - name: Rollout
  - name: Audit
paths:
  /api/v1/config:
    get:
      tags: [Config]
      summary: Fetch config values for a service scope and environment
      operationId: getConfig
      parameters:
        - $ref: '#/components/parameters/XRequestID'
        - in: query
          name: environment
          schema: { type: string, enum: [dev, staging, prod], default: prod }
        - in: query
          name: service_scope
          schema: { type: string, example: "auth-service" }
        - in: query
          name: region
          schema: { type: string, example: "us-east-1" }
      responses:
        '200':
          description: Key/value map
          content:
            application/json:
              schema: { type: object, additionalProperties: true }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/config/{key}:
    patch:
      tags: [Config]
      summary: Update a configuration value (idempotent)
      operationId: patchConfig
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/XRequestID'
        - in: path
          name: key
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PatchConfigRequest' }
      responses:
        '200':
          description: Updated value
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PatchConfigResponse' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/config/import:
    post:
      tags: [Config]
      summary: Bulk import configuration
      operationId: importConfig
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/XRequestID'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ImportConfigRequest' }
      responses:
        '201':
          description: Rows imported
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ImportConfigResponse' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/config/export:
    get:
      tags: [Config]
      summary: Export configuration snapshot
      operationId: exportConfig
      parameters:
        - $ref: '#/components/parameters/XRequestID'
      responses:
        '200':
          description: Exported config
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ExportConfigResponse' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/config/rollback:
    post:
      tags: [Config]
      summary: Roll back configuration to a previous version
      operationId: rollbackConfig
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/XRequestID'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RollbackRequest' }
      responses:
        '200':
          description: Rollback applied
          content:
            application/json:
              schema: { $ref: '#/components/schemas/RollbackResponse' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/config/audit:
    get:
      tags: [Audit]
      summary: Query config audit logs
      operationId: queryAudit
      parameters:
        - $ref: '#/components/parameters/XRequestID'
        - in: query
          name: key
          schema: { type: string }
        - in: query
          name: actor_id
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 500, default: 100 }
      responses:
        '200':
          description: Audit entries
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuditResponse' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/config/rollout-rules:
    post:
      tags: [Rollout]
      summary: Upsert rollout/targeting rule
      operationId: upsertRolloutRule
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/XRequestID'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpsertRolloutRuleRequest' }
      responses:
        '201':
          description: Rule created/updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/RolloutRuleResponse' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    IdempotencyKey:
      in: header
      name: Idempotency-Key
      required: true
      schema: { type: string }
      description: Required for mutating routes; 7-day TTL with body hash replay detection.
    XRequestID:
      in: header
      name: X-Request-Id
      schema: { type: string }
      description: Correlation id; generated if absent.
  responses:
    BadRequest:
      description: Invalid input
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
    Unauthorized:
      description: Missing or invalid bearer token
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
    Forbidden:
      description: Caller not permitted
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
    Conflict:
      description: Idempotency conflict or conflicting state
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
    InternalError:
      description: Unexpected failure
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
  schemas:
    SuccessResponse:
      type: object
      properties:
        status: { type: string, example: success }
        data: {}
    ErrorResponse:
      type: object
      required: [message]
      properties:
        status: { type: string, example: error }
        code: { type: string }
        message: { type: string }
        retry_after_seconds: { type: integer }
    PatchConfigRequest:
      type: object
      properties:
        environment: { type: string }
        service_scope: { type: string }
        value: {}
        value_type: { type: string, enum: [string, number, boolean, json, secret] }
        version: { type: integer }
    PatchConfigResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                key: { type: string }
                version: { type: integer }
                environment: { type: string }
                service_scope: { type: string }
    ImportConfigRequest:
      type: object
      properties:
        environment: { type: string }
        items:
          type: array
          items:
            type: object
            properties:
              key: { type: string }
              value: {}
              value_type: { type: string }
              service_scope: { type: string }
    ImportConfigResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                imported: { type: integer }
    ExportConfigResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              additionalProperties: true
    RollbackRequest:
      type: object
      required: [key, target_version]
      properties:
        key: { type: string }
        target_version: { type: integer }
    RollbackResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                key: { type: string }
                version: { type: integer }
                rolled_back_to: { type: integer }
    UpsertRolloutRuleRequest:
      type: object
      required: [key, rule_type]
      properties:
        key: { type: string }
        rule_type: { type: string, enum: [percentage, role, tier] }
        percentage: { type: integer, minimum: 0, maximum: 100 }
        role: { type: string }
        tier: { type: string }
    RolloutRuleResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                rule_id: { type: string }
                key: { type: string }
                rule_type: { type: string }
                percentage: { type: integer }
                role: { type: string }
                tier: { type: string }
                created_at: { type: string, format: date-time }
    AuditResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                type: object
                properties:
                  audit_id: { type: string }
                  key: { type: string }
                  action_type: { type: string }
                  actor_id: { type: string }
                  action_at: { type: string, format: date-time }
                  change_detail: {}
