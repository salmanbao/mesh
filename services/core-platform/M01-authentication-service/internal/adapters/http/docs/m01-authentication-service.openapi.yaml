openapi: 3.0.3
info:
  title: M01 Authentication Service API
  version: 1.0.0
  description: |
    Full REST contract for M01 authentication service.
    Responses follow service envelope conventions:
    - Success with data: `{ "status": "success", "data": ... }`
    - Success with message: `{ "status": "success", "message": "..." }`
    - Error: `{ "status": "error", "code": "...", "message": "..." }`
servers:
  - url: /
tags:
  - name: Health
  - name: Auth
  - name: Recovery
  - name: Sessions
  - name: OIDC
paths:
  /healthz:
    get:
      tags: [Health]
      summary: Liveness probe
      operationId: healthz
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: ok
  /readyz:
    get:
      tags: [Health]
      summary: Readiness probe
      operationId: readyz
      responses:
        "200":
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: ready

  /auth/v1/register:
    post:
      tags: [Auth]
      summary: Register a local account
      operationId: registerUser
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          description: Optional idempotency key for safe client retries.
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
            example:
              email: user@example.com
              password: StrongPass123!
              role: INFLUENCER
              terms_accepted: true
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponseEnvelope"
        "400":
          $ref: "#/components/responses/ValidationError"
        "409":
          $ref: "#/components/responses/ConflictError"
        "501":
          $ref: "#/components/responses/NotImplementedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/register/complete:
    post:
      tags: [Auth]
      summary: Complete deferred OIDC registration
      operationId: completeRegistration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterCompleteRequest"
      responses:
        "200":
          description: Registration completed and session issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponseEnvelope"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/login:
    post:
      tags: [Auth]
      summary: Authenticate with email and password
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login accepted (token or 2FA challenge)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponseEnvelope"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: error
                code: INVALID_CREDENTIALS
                message: invalid email or password
        "429":
          description: Account temporarily locked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: error
                code: ACCOUNT_LOCKED
                message: account temporarily locked
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/2fa/verify:
    post:
      tags: [Auth]
      summary: Verify MFA challenge and issue session token
      operationId: verifyTwoFA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TwoFAVerifyRequest"
      responses:
        "200":
          description: MFA verified and token issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponseEnvelope"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/2fa/setup:
    post:
      tags: [Auth]
      summary: Enable or disable 2FA method for current user
      operationId: setupTwoFA
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TwoFASetupRequest"
      responses:
        "200":
          description: Updated 2FA method state
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TwoFASetupResponseEnvelope"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/password/reset-request:
    post:
      tags: [Recovery]
      summary: Request password reset email
      operationId: requestPasswordReset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PasswordResetRequestEmail"
      responses:
        "200":
          description: Request accepted (same response regardless of account existence)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: If the email exists, a password reset link has been sent
        "400":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/password/reset:
    post:
      tags: [Recovery]
      summary: Reset password with one-time token
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PasswordResetRequest"
      responses:
        "200":
          description: Password reset completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: Password reset successful. You can now login with your new password.
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/email/verify-request:
    post:
      tags: [Recovery]
      summary: Request email verification token
      operationId: requestEmailVerification
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Verification email request accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: Verification email sent
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/email/verify:
    post:
      tags: [Recovery]
      summary: Verify email address with token
      operationId: verifyEmail
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EmailVerifyRequest"
      responses:
        "200":
          description: Email verified
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: Email verified successfully
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/refresh:
    post:
      tags: [Auth]
      summary: Rotate access token for current session
      operationId: refreshToken
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Token refreshed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshResponseEnvelope"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/logout:
    post:
      tags: [Auth]
      summary: Revoke current session
      operationId: logoutCurrentSession
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current session revoked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: Logged out successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/account:
    delete:
      tags: [Auth]
      summary: Request account deletion
      operationId: deleteAccount
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Account deletion accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: Account deletion requested successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/sessions:
    get:
      tags: [Sessions]
      summary: List user sessions
      operationId: listSessions
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Session list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionsResponseEnvelope"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"
    delete:
      tags: [Sessions]
      summary: Revoke all user sessions
      operationId: revokeAllSessions
      security:
        - bearerAuth: []
      responses:
        "200":
          description: All sessions revoked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: All sessions revoked successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/sessions/{session_id}:
    delete:
      tags: [Sessions]
      summary: Revoke one session by ID
      operationId: revokeSessionById
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: session_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Session revoked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: Session revoked successfully
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/login-history:
    get:
      tags: [Sessions]
      summary: List recent login attempts
      operationId: listLoginHistory
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: days
          required: false
          description: Return attempts from the last N days when provided.
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: status
          required: false
          description: Optional status filter (for example SUCCESS or FAILED).
          schema:
            type: string
      responses:
        "200":
          description: Login attempts list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginHistoryResponseEnvelope"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/oidc/authorize:
    get:
      tags: [OIDC]
      summary: Build OIDC authorization redirect
      operationId: oidcAuthorize
      parameters:
        - in: query
          name: provider
          required: false
          schema:
            type: string
            default: google
          description: OIDC provider key. Defaults to google.
        - in: query
          name: redirect_uri
          required: true
          schema:
            type: string
            format: uri
        - in: query
          name: client_context
          required: false
          schema:
            type: string
        - in: query
          name: login_hint
          required: false
          schema:
            type: string
        - in: query
          name: response_mode
          required: false
          schema:
            type: string
            enum: [redirect, json]
            default: redirect
      responses:
        "302":
          description: Redirect to provider authorize URL
          headers:
            Location:
              description: OIDC provider authorization URL.
              schema:
                type: string
                format: uri
        "200":
          description: Authorization URL payload for API clients
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OIDCAuthorizeResponseEnvelope"
        "400":
          $ref: "#/components/responses/ValidationError"
        "501":
          $ref: "#/components/responses/NotImplementedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/oidc/callback:
    get:
      tags: [OIDC]
      summary: Handle OIDC callback and finalize login
      operationId: oidcCallback
      parameters:
        - in: query
          name: code
          required: true
          schema:
            type: string
        - in: query
          name: state
          required: true
          schema:
            type: string
        - in: query
          name: response_mode
          required: false
          schema:
            type: string
            enum: [redirect, json]
            default: redirect
      responses:
        "302":
          description: Redirect back to client redirect URI with auth result in fragment
          headers:
            Location:
              description: Client redirect URI containing auth fragment.
              schema:
                type: string
                format: uri
        "200":
          description: Callback result payload for API clients
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OIDCCallbackResponseEnvelope"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "501":
          $ref: "#/components/responses/NotImplementedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/oidc/link:
    post:
      tags: [OIDC]
      summary: Link OIDC identity to current user
      operationId: oidcLink
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OIDCLinkRequest"
      responses:
        "200":
          description: Provider linked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OIDCLinkResponseEnvelope"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "501":
          $ref: "#/components/responses/NotImplementedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/v1/oidc/link/{provider}:
    delete:
      tags: [OIDC]
      summary: Unlink OIDC identity from current user
      operationId: oidcUnlink
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: provider
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Provider unlinked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageResponse"
              example:
                status: success
                message: OIDC connection removed
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalError"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    ValidationError:
      description: Input validation failed
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            status: error
            code: VALIDATION_ERROR
            message: invalid input
    UnauthorizedError:
      description: Invalid or missing credentials
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            status: error
            code: UNAUTHORIZED
            message: invalid or missing credentials
    ConflictError:
      description: Resource conflict (including idempotency conflict)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            status: error
            code: CONFLICT
            message: conflict
    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            status: error
            code: NOT_FOUND
            message: resource not found
    NotImplementedError:
      description: Feature not implemented in current runtime slice
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            status: error
            code: NOT_IMPLEMENTED
            message: not implemented
    InternalError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            status: error
            code: INTERNAL_ERROR
            message: internal server error

  schemas:
    ErrorResponse:
      type: object
      required: [status, code, message]
      properties:
        status:
          type: string
          enum: [error]
        code:
          type: string
        message:
          type: string

    SuccessMessageResponse:
      type: object
      required: [status, message]
      properties:
        status:
          type: string
          enum: [success]
        message:
          type: string

    RegisterRequest:
      type: object
      required: [email, password, terms_accepted]
      properties:
        email:
          type: string
          format: email
          description: Local account email.
        password:
          type: string
          format: password
          description: Local account password.
        role:
          type: string
          description: Optional role override. Defaults to service default role.
        terms_accepted:
          type: boolean

    RegisterCompleteRequest:
      type: object
      required: [completion_token]
      properties:
        completion_token:
          type: string
          description: Short-lived token issued by OIDC callback when registration is incomplete.
        role:
          type: string
          description: Optional completion profile field.

    RegisterResponseData:
      type: object
      required: [user_id]
      properties:
        user_id:
          type: string
          format: uuid
        token:
          type: string
          description: Present for OIDC registration/login response path.
        session_id:
          type: string
          format: uuid
          description: Present for OIDC registration/login response path.
        expires_in:
          type: integer
          format: int64
          description: Access token TTL in seconds when `token` is returned.

    RegisterResponseEnvelope:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [success]
        data:
          $ref: "#/components/schemas/RegisterResponseData"

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        remember_device:
          type: boolean
        device_name:
          type: string
        device_os:
          type: string
        ip_address:
          type: string
        user_agent:
          type: string

    LoginResponse:
      type: object
      required: [requires_2fa]
      properties:
        requires_2fa:
          type: boolean
        temp_token:
          type: string
          description: Present when `requires_2fa=true`.
        token:
          type: string
          description: Present when `requires_2fa=false`.
        session_id:
          type: string
          format: uuid
          description: Present when a full session token is issued.
        expires_in:
          type: integer
          format: int64

    LoginResponseEnvelope:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [success]
        data:
          $ref: "#/components/schemas/LoginResponse"

    TwoFAVerifyRequest:
      type: object
      required: [code]
      properties:
        temp_token:
          type: string
          description: Optional in body when provided as bearer token.
        code:
          type: string
        method:
          type: string
          description: Optional explicit method to validate against challenge method.
        remember_device:
          type: boolean
        device_name:
          type: string
        device_os:
          type: string
        ip_address:
          type: string
        user_agent:
          type: string

    TwoFASetupRequest:
      type: object
      required: [action, method]
      properties:
        action:
          type: string
          enum: [enable, disable]
        method:
          type: string
          description: One of `sms`, `email`, `authenticator_app`, `totp`.

    TwoFASetupResponse:
      type: object
      required: [method, enabled]
      properties:
        method:
          type: string
        enabled:
          type: boolean
        secret:
          type: string
          description: Returned when enabling authenticator app.
        backup_codes:
          type: array
          items:
            type: string
          description: Returned when enabling authenticator app.

    TwoFASetupResponseEnvelope:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [success]
        data:
          $ref: "#/components/schemas/TwoFASetupResponse"

    PasswordResetRequestEmail:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email

    PasswordResetRequest:
      type: object
      required: [token, new_password]
      properties:
        token:
          type: string
        new_password:
          type: string
          format: password

    EmailVerifyRequest:
      type: object
      required: [token]
      properties:
        token:
          type: string

    RefreshResponseData:
      type: object
      required: [token, expires_in]
      properties:
        token:
          type: string
        expires_in:
          type: integer
          format: int64

    RefreshResponseEnvelope:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [success]
        data:
          $ref: "#/components/schemas/RefreshResponseData"

    SessionItem:
      type: object
      required:
        [session_id, device_name, device_os, ip_address, created_at, last_activity_at, expires_at, is_current]
      properties:
        session_id:
          type: string
          format: uuid
        device_name:
          type: string
        device_os:
          type: string
        ip_address:
          type: string
        created_at:
          type: string
          format: date-time
        last_activity_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        revoked_at:
          type: string
          format: date-time
          nullable: true
        is_current:
          type: boolean

    SessionsResponseData:
      type: object
      required: [sessions]
      properties:
        sessions:
          type: array
          items:
            $ref: "#/components/schemas/SessionItem"

    SessionsResponseEnvelope:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [success]
        data:
          $ref: "#/components/schemas/SessionsResponseData"

    LoginHistoryItem:
      type: object
      required: [id, timestamp, status, ip_address]
      properties:
        id:
          type: integer
          format: int64
        timestamp:
          type: string
          format: date-time
        status:
          type: string
        failure_reason:
          type: string
        ip_address:
          type: string
        device_name:
          type: string
        device_os:
          type: string

    LoginHistoryResponseData:
      type: object
      required: [attempts]
      properties:
        attempts:
          type: array
          items:
            $ref: "#/components/schemas/LoginHistoryItem"

    LoginHistoryResponseEnvelope:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [success]
        data:
          $ref: "#/components/schemas/LoginHistoryResponseData"

    OIDCLinkRequest:
      type: object
      required: [authorization_code]
      properties:
        provider:
          type: string
          description: OIDC provider key (for example `google`). Defaults to `google` when omitted.
        authorization_code:
          type: string
        redirect_uri:
          type: string
          format: uri
        nonce:
          type: string
        code_verifier:
          type: string

    OIDCLinkResponseData:
      type: object
      required: [provider, linked]
      properties:
        provider:
          type: string
        linked:
          type: boolean

    OIDCLinkResponseEnvelope:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [success]
        data:
          $ref: "#/components/schemas/OIDCLinkResponseData"

    OIDCAuthorizeResponseData:
      type: object
      required: [authorize_url, state]
      properties:
        authorize_url:
          type: string
          format: uri
        state:
          type: string

    OIDCAuthorizeResponseEnvelope:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [success]
        data:
          $ref: "#/components/schemas/OIDCAuthorizeResponseData"

    OIDCCallbackResponseData:
      type: object
      properties:
        redirect_url:
          type: string
          format: uri
        user_id:
          type: string
          format: uuid
        token:
          type: string
        session_id:
          type: string
          format: uuid
        expires_in:
          type: integer
          format: int64
        registration_incomplete:
          type: boolean
        completion_token:
          type: string

    OIDCCallbackResponseEnvelope:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [success]
        data:
          $ref: "#/components/schemas/OIDCCallbackResponseData"
